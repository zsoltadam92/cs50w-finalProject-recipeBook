{% extends "recepies/layout.html" %} {% load multiply_percentage %} {% load extra_filters %}


{% block content %}


<div class="container mt-3">
    <h1>{{ recipe.title }}</h1>
    {% if user == recipe.creator %}
      <form action="{% url 'edit_recipe' recipe.id %}" method="get">
        <button type="submit" class="btn btn-warning">Edit</button>
      </form> 
    {% endif %}
    {% if user.is_authenticated %}
      <form method="post" action="{% url 'add_to_favorites' recipe.id %}" >
        {% csrf_token %}
        {% if recipe in user_favorite_recipes %}
          <button type="submit" class="btn btn-danger">Remove from Favorites</button>
        {% else %}
          <button type="submit" class="btn btn-warning">Add to Favorites</button>
        {% endif %}
      </form>
    {% endif %}
    <p>{{ recipe.creator }} - {{ recipe.created_at }} </p>
    {% if already_rated %}
      <p>You have already rated this recipe.</p>
    {% else %}

      {% if user.is_authenticated %}
        <form method="post" action="{% url 'recipe_details' recipe.id %}" >
          {% csrf_token %}
          <div class="rating">
            {% for choice in form.ratings.field.choices %}
            <input id="star{{ choice.0 }}" type="radio" name="ratings" value="{{ choice.0 }}" class="star-checkbox" style="display: none;">
            <label for="star{{ choice.0 }}" class="star">&#9733;</label>
            {% endfor %}
        </div>
          <button type="submit" class="btn btn-primary">Rating</button>
        </form>  
      {% endif %}
    {% endif %}
    

    <p>Avarage: {{ recipe.average_rating|floatformat:1 }}  <span class="star-orange" style="font-size: 1.3rem">&#9733;</span></p>
    <p>{{ total_ratings }} review{{ recipe.ratings|pluralize:"s" }}</p>

    <div class="ratings-chart" style="max-width: 400px">
      {% for rate, count in ratings.items %}
      <div class="d-flex">
        <p class="mr-2" style="width: 80px">
          <span class="star-orange">
            {{ rate|repeat_star }}
          </span>
        </p>
        <div style="width: 250px">
          <div class="rating-bar mr-auto" style="width: {{ count|multiply_percentage:total_ratings }}; background-color: #4CAF50; height: 20px; color: white; text-align: center; margin-bottom: 5px;">
          </div>
        </div>
        <p class="ml-2" style="width: 90px">{{ count }} vote{{ count|pluralize:"s" }}</p>
      </div>
      {% endfor %}
    </div>
  
  
    <div>
      {% for category in recipe.categories.all %}
          <a href="{% url 'recipes_by_category' category.title %}" class="category-bubble badge ">{{ category.title }}</a>
      {% endfor %}
  </div>
    <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" style="width: 250px ">
    <p>Yields: {{ recipe.serving }} serving(s)</p>
    <p>Preparation time: {{ recipe.preparation_time }} min</p>
    <p>Difficulty: {{ recipe.difficulty }}</p>
    <h3>Ingredients:</h3>
  
    
    <label for="new-servings">Adagok száma:</label>
    <input type="number" id="new-servings" value="{{ recipe.serving }}" oninput="updateIngredients()">
    <input type="hidden" id="original-servings" value="{{ recipe.serving }}">

    <div id="ingredients">
      <ul>
        {% for ingredient in recipe.ingredients.all %}
        <li>
          <button onclick="addToShoppingList({{ recipe.id }}, '{{ ingredient.name }}')">Add</button>
          <input type="checkbox" class="ingredient-checkbox" onchange="toggleStrikethrough(this)">
          <span>
            <span class="ingredient-quantity" data-original-quantity="{{ ingredient.quantity }}">{{ ingredient.quantity }}</span>
            <span>{{ ingredient.unit }} {{ ingredient.name }}</span>
          </span> 
        </li>
        {% endfor %}

      </ul>
    </div>

    <h3>Preparation:</h3>
      {% for preparation in recipe.get_preparation_section %}
        <p>{{ preparation }}</p>
      {% endfor %}



      <div class="row justify-content-center align-items-start">
        <div class="col-sm-5  col-lg-3 d-flex flex-column mr-5">
          {% if user.is_authenticated %}
            <!-- Comment Form -->
            <form action="{% url 'recipe_details' recipe.id %}" method="post">
              {% csrf_token %}
              {{commentForm}}
              <input type="submit" name="comment_form" value="Send Comment" class="mt-3 btn btn-primary" />
            </form>
          {% endif %}
        </div>
        
        <div class="col-sm-6 col-md-6 d-flex flex-column ">
          <!-- Comments Section -->
          <h3 class="mt-2 mb-3">Comments</h3>
          <div class="overflow-auto" style="height: 250px">
            {% for comment in comments %}
                <div class="media mt-4">
                  <div class="media-body">
                    <div class="d-flex justify-content-between">
                      <h5 class="mb-3">{{ comment.user.username }}</h5>
                      <small class="text-muted">{{ comment.created_at }}</small>
                    </div>
                    <p>{{ comment.content }}</p>
                  </div>
                </div>
                <hr>
            {% endfor %} 
          </div>
      </div>
    </div>
      

<script>

  
    function updateIngredients() {
        const originalServings = parseInt(document.getElementById('original-servings').value);
        const newServings = parseInt(document.getElementById('new-servings').value);
        const scale = newServings / originalServings;
    
        document.querySelectorAll('.ingredient-quantity').forEach(function(item) {
            const originalQuantity = parseFloat(item.dataset.originalQuantity);
            item.textContent = (originalQuantity * scale).toFixed(2); // Két tizedesjegy pontossággal jelenítjük meg
        });
    }
    
    


  function toggleClass(element, className, condition) {
    condition ? element.classList.add(className) : element.classList.remove(className);
};

function toggleStrikethrough(checkbox) {
    const textElement = checkbox.nextElementSibling;
    toggleClass(textElement, 'strikethrough', checkbox.checked);
}



document.querySelectorAll('.rating label').forEach(label => {
  label.addEventListener('click', () => {
      // Minden csillagot először szürkére állít
      document.querySelectorAll('.rating label').forEach(innerLabel => {
          innerLabel.style.color = 'grey';
      });

      // Az adott csillag és minden előző csillag arany színű lesz
      let currentLabel = label;
      while (currentLabel) {
          currentLabel.style.color = 'gold';
          currentLabel = currentLabel.previousElementSibling ? currentLabel.previousElementSibling.previousElementSibling : null;
      }
  });
});

function addToShoppingList(recipeId, ingredientName) {
  fetch(`/add-to-shopping-list/${recipeId}/${ingredientName}/`, {
      method: 'POST',
      headers: {
          'X-CSRFToken': getCookie('csrftoken'),  // CSRF token
          'Content-Type': 'application/json'
      },
      body: JSON.stringify({ingredientName: ingredientName})
  })
  .then(response => response.json())
  .then(data => {
      if (data.status === 'success') {
          alert('Hozzávaló hozzáadva a bevásárlólistához.');
      } else {
          alert('Hiba történt: ' + data.message);
      }
  })
  .catch(error => console.error('Hiba:', error));
}



{% comment %} function togglePurchased(itemId) {
    fetch(`/shopping-list/toggle-purchased/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),  // CSRF token beállítása
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Purchase status updated:', data.purchased);
        } else {
            alert('Failed to update purchase status');
        }
    });
} {% endcomment %}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}


</script>





{% endblock %}